"use strict";
var os = require("os");
var child_process = require("child_process");
var Promise = require("bluebird");
var superagent = require("superagent");
var lsusbdev_1 = require("lsusbdev");
var linux_cpu_temp_1 = require("linux-cpu-temp");
var networkstatus_1 = require("networkstatus");
var lsdisks = require("ls-disks");
var exec = child_process.exec;
function getExternalIp() {
    return new Promise(function (resolve, reject) {
        superagent.get('https://api.ipify.org?format=json').end(function (err, res) {
            if (err) {
                reject(err);
            }
            else {
                resolve(res.body.ip);
            }
        });
    });
}
function sysinfo() {
    return new Promise(function (resolve, reject) {
        var object = {};
        object.updatedAt = new Date().getTime();
        var callbacked = false;
        var timo = setTimeout(function () {
            if (!callbacked) {
                console.log("timeout bootId read timeout");
                reject("timeout");
            }
        }, 10000);
        object.system = {
            loadavg: os.loadavg(),
            freemem: os.freemem(),
            totalmem: os.totalmem(),
            release: os.release(),
            arch: os.arch(),
            ostype: os.type(),
            platform: os.platform(),
            cores: os.cpus()
        };
        exec("cat /proc/sys/kernel/random/boot_id", { timeout: 9000 }, function (error, stdout, stderr) {
            if (error != null) {
                callbacked = true;
                clearTimeout(timo);
                reject(error);
            }
            else if (stderr && stderr != null) {
                callbacked = true;
                clearTimeout(timo);
                reject(stderr);
            }
            else {
                callbacked = true;
                clearTimeout(timo);
                var callbacked2_1 = false;
                var timo2_1 = setTimeout(function () {
                    if (!callbacked2_1) {
                        console.log("timeout bootTime read timeout");
                        reject("timeout");
                    }
                }, 10000);
                object.bootId = stdout.toString().replace("\n", "");
                exec("cat /proc/stat | grep btime | awk '{ print $2 }'", { timeout: 9000 }, function (error, stdout, stderr) {
                    if (error != null) {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        reject(error);
                    }
                    else if (stderr && stderr != null) {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        reject(stderr);
                    }
                    else {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        object.bootTime = parseInt(stdout.toString()) * 1000;
                        lsusbdev_1.default().then(function (data) {
                            object.usbDevices = data;
                            object.drives = lsdisks.all();
                            networkstatus_1.default().then(function (data) {
                                object.networks = data.networks;
                                object.network = data.network;
                                if (object.network) {
                                    object.network.externalIp = '';
                                }
                                linux_cpu_temp_1.default().then(function (a) {
                                    object.cputemp = a;
                                    if (object.network) {
                                        getExternalIp().then(function (a) {
                                            object.network.externalIp = a;
                                            resolve(object);
                                        }).catch(function () {
                                            resolve(object);
                                        });
                                    }
                                    else {
                                        resolve(object);
                                    }
                                }).catch(function (err) {
                                    if (object.network) {
                                        getExternalIp().then(function (a) {
                                            object.network.externalIp = a;
                                            resolve(object);
                                        }).catch(function () {
                                            resolve(object);
                                        });
                                    }
                                    else {
                                        resolve(object);
                                    }
                                });
                            });
                        });
                    }
                });
            }
        });
    });
}
exports.sysinfo = sysinfo;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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T0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO3dDQUNuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7NENBQ0wsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO3dDQUNuQixDQUFDLENBQUMsQ0FBQTtvQ0FDTixDQUFDO29DQUFDLElBQUksQ0FBQyxDQUFDO3dDQUNKLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQ0FDbkIsQ0FBQztnQ0FDTCxDQUFDLENBQUMsQ0FBQTs0QkFFTixDQUFDLENBQUMsQ0FBQzt3QkFDUCxDQUFDLENBQUMsQ0FBQztvQkFDUCxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDO0FBeEdELDBCQXdHQztBQUFBLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBvcyBmcm9tIFwib3NcIjtcbmltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcblxuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcblxuaW1wb3J0ICogYXMgc3VwZXJhZ2VudCBmcm9tIFwic3VwZXJhZ2VudFwiO1xuXG5cbmltcG9ydCBsc3VzYiBmcm9tIFwibHN1c2JkZXZcIjtcblxuaW1wb3J0IHRlbXBjcHVzIGZyb20gXCJsaW51eC1jcHUtdGVtcFwiO1xuXG5cbmltcG9ydCBuZXR3b3Jrc3RhdHVzIGZyb20gXCJuZXR3b3Jrc3RhdHVzXCJcblxuXG5pbXBvcnQgKiBhcyBsc2Rpc2tzIGZyb20gXCJscy1kaXNrc1wiO1xuXG5jb25zdCBleGVjID0gY2hpbGRfcHJvY2Vzcy5leGVjO1xuXG5pbnRlcmZhY2UgSWNvcmVzIHtcblxuICAgIHRlbXA6IG51bWJlcjtcbiAgICB1bml0OiBzdHJpbmdcbiAgICBjb3JlbnVtYmVyOiBudW1iZXI7XG4gICAgdmVyc2lvbjogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJdGVtcCB7XG5cbiAgICB0ZW1wZXJhdHVyZTogbnVtYmVyO1xuICAgIHVuaXQ6IHN0cmluZztcbiAgICBtYXg6IG51bWJlcjtcbiAgICBtaW46IG51bWJlcjtcbiAgICBjb3JlczogSWNvcmVzW107XG5cbn1cblxuXG5cblxuaW50ZXJmYWNlIElTY2FuIHtcbiAgICBlc3NpZDogc3RyaW5nO1xuICAgIG1hYzogc3RyaW5nO1xuICAgIHNpZ25hbDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSU5ldHdvcmsge1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBtYWM6IHN0cmluZztcbiAgICBpbnRlcmZhY2U6IHN0cmluZztcbiAgICBlc3NpZD86IHN0cmluZztcbiAgICBzY2FuPzogSVNjYW5bXTtcbiAgICBpcD86IHN0cmluZztcbiAgICBnYXRld2F5Pzogc3RyaW5nO1xuICAgIGV4dGVybmFsSXA/OiBzdHJpbmc7XG59XG5cblxuaW50ZXJmYWNlIElOZXRTdGF0dXMge1xuXG4gICAgbmV0d29ya3M6IElOZXR3b3JrW107XG4gICAgbmV0d29yazogSU5ldHdvcms7XG59XG5cblxuXG5pbnRlcmZhY2UgTHN1c2JkZXZBbnN3ZXIge1xuICAgIGRldjogc3RyaW5nO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBodWI6IHN0cmluZztcbiAgICBwcm9kdWN0OiBzdHJpbmc7XG4gICAgaWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElQYXJ0aXRpb24ge1xuICAgIHBhcnRpdGlvbjogc3RyaW5nO1xuICAgIHNlY3RvcnM6IG51bWJlcjtcbiAgICBzZWN0b3JzX3N0YXJ0OiBudW1iZXI7XG4gICAgc2VjdG9yc19zdG9wOiBudW1iZXI7XG4gICAgdHlwZTogc3RyaW5nO1xuICAgIGJvb3Q6IGJvb2xlYW47XG4gICAgc2l6ZTogbnVtYmVyO1xuICAgIGxhYmVsPzogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBodW1hbnNpemU6IHN0cmluZztcbiAgICB1c2VkOiBzdHJpbmc7XG4gICAgYXZhaWxhYmxlOiBzdHJpbmc7XG4gICAgcGVyY2VudHVzZWQ6IHN0cmluZztcbiAgICBtb3VudGVkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJRGlzayB7XG4gICAgZGlzazogc3RyaW5nO1xuICAgIHNlY3RvcnM6IG51bWJlcjtcbiAgICBzaXplOiBudW1iZXI7XG4gICAgcGFydGl0aW9uczogSVBhcnRpdGlvbltdO1xuICAgIGJsb2NrOiBudW1iZXI7XG4gICAgdXNlZF9ibG9ja3M6IG51bWJlcjtcbn1cblxuaW50ZXJmYWNlIElDcHUge1xuICAgIG1vZGVsOiBzdHJpbmc7XG4gICAgc3BlZWQ6IG51bWJlcjtcbiAgICB0aW1lczoge1xuICAgICAgICB1c2VyOiBudW1iZXI7XG4gICAgICAgIG5pY2U6IG51bWJlcjtcbiAgICAgICAgc3lzOiBudW1iZXI7XG4gICAgICAgIGlkbGU6IG51bWJlcjtcbiAgICAgICAgaXJxOiBudW1iZXJcbiAgICB9XG59XG5pbnRlcmZhY2UgQW5zd2VyIHtcbiAgICBib290SWQ6IHN0cmluZztcbiAgICBib290VGltZTogbnVtYmVyO1xuICAgIHVwZGF0ZWRBdDogbnVtYmVyO1xuICAgIHVzYkRldmljZXM6IExzdXNiZGV2QW5zd2VyW107XG4gICAgZHJpdmVzOiBJRGlza1tdO1xuICAgIG5ldHdvcmtzOiBJTmV0d29ya1tdO1xuICAgIG5ldHdvcms6IElOZXR3b3JrO1xuICAgIGNwdXRlbXA6IEl0ZW1wO1xuICAgIHN5c3RlbToge1xuICAgICAgICBsb2FkYXZnOiBudW1iZXJbXTtcbiAgICAgICAgZnJlZW1lbTogbnVtYmVyO1xuICAgICAgICB0b3RhbG1lbTogbnVtYmVyO1xuICAgICAgICByZWxlYXNlOiBzdHJpbmc7XG4gICAgICAgIGFyY2g6IHN0cmluZztcbiAgICAgICAgb3N0eXBlOiBzdHJpbmc7XG4gICAgICAgIHBsYXRmb3JtOiBzdHJpbmc7XG4gICAgICAgIGNvcmVzOiBJQ3B1W107XG4gICAgfVxufVxuXG5mdW5jdGlvbiBnZXRFeHRlcm5hbElwKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICAgIHN1cGVyYWdlbnQuZ2V0KCdodHRwczovL2FwaS5pcGlmeS5vcmc/Zm9ybWF0PWpzb24nKS5lbmQoZnVuY3Rpb24gKGVyciwgcmVzKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXMuYm9keS5pcClcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc3lzaW5mbygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8QW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG5cblxuICAgICAgICBsZXQgb2JqZWN0ID0gPEFuc3dlcj57fTtcbiAgICAgICAgb2JqZWN0LnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuXG4gICAgICAgIGxldCBjYWxsYmFja2VkID0gZmFsc2U7XG4gICAgICAgIGxldCB0aW1vID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoIWNhbGxiYWNrZWQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRpbWVvdXQgYm9vdElkIHJlYWQgdGltZW91dFwiKTtcbiAgICAgICAgICAgICAgICByZWplY3QoXCJ0aW1lb3V0XCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCAxMDAwMCk7XG4gICAgICAgIG9iamVjdC5zeXN0ZW0gPSB7XG4gICAgICAgICAgICBsb2FkYXZnOiBvcy5sb2FkYXZnKCksXG4gICAgICAgICAgICBmcmVlbWVtOiBvcy5mcmVlbWVtKCksXG4gICAgICAgICAgICB0b3RhbG1lbTogb3MudG90YWxtZW0oKSxcbiAgICAgICAgICAgIHJlbGVhc2U6IG9zLnJlbGVhc2UoKSxcbiAgICAgICAgICAgIGFyY2g6IG9zLmFyY2goKSxcbiAgICAgICAgICAgIG9zdHlwZTogb3MudHlwZSgpLFxuICAgICAgICAgICAgcGxhdGZvcm06IG9zLnBsYXRmb3JtKCksXG4gICAgICAgICAgICBjb3Jlczogb3MuY3B1cygpXG4gICAgICAgIH07XG4gICAgICAgIGV4ZWMoXCJjYXQgL3Byb2Mvc3lzL2tlcm5lbC9yYW5kb20vYm9vdF9pZFwiLCB7IHRpbWVvdXQ6IDkwMDAgfSwgZnVuY3Rpb24gKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltbyk7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RkZXJyICYmIHN0ZGVyciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbW8pO1xuICAgICAgICAgICAgICAgIHJlamVjdChzdGRlcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltbyk7XG5cbiAgICAgICAgICAgICAgICBsZXQgY2FsbGJhY2tlZDIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBsZXQgdGltbzIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja2VkMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0aW1lb3V0IGJvb3RUaW1lIHJlYWQgdGltZW91dFwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChcInRpbWVvdXRcIik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LCAxMDAwMCk7XG5cbiAgICAgICAgICAgICAgICBvYmplY3QuYm9vdElkID0gc3Rkb3V0LnRvU3RyaW5nKCkucmVwbGFjZShcIlxcblwiLCBcIlwiKTtcblxuICAgICAgICAgICAgICAgIGV4ZWMoXCJjYXQgL3Byb2Mvc3RhdCB8IGdyZXAgYnRpbWUgfCBhd2sgJ3sgcHJpbnQgJDIgfSdcIiwgeyB0aW1lb3V0OiA5MDAwIH0sIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrZWQyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1vMik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0ZGVyciAmJiBzdGRlcnIgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tlZDIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbW8yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChzdGRlcnIpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tlZDIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbW8yKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LmJvb3RUaW1lID0gcGFyc2VJbnQoc3Rkb3V0LnRvU3RyaW5nKCkpICogMTAwMDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgbHN1c2IoKS50aGVuKGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LnVzYkRldmljZXMgPSBkYXRhO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5kcml2ZXMgPSBsc2Rpc2tzLmFsbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ldHdvcmtzdGF0dXMoKS50aGVuKGZ1bmN0aW9uIChkYXRhOiBJTmV0U3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5uZXR3b3JrcyA9IGRhdGEubmV0d29ya3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5uZXR3b3JrID0gZGF0YS5uZXR3b3JrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0Lm5ldHdvcmspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5uZXR3b3JrLmV4dGVybmFsSXAgPSAnJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGNwdXMoKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuY3B1dGVtcCA9IGFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmplY3QubmV0d29yaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEV4dGVybmFsSXAoKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5uZXR3b3JrLmV4dGVybmFsSXAgPSBhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvYmplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvYmplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvYmplY3QubmV0d29yaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdldEV4dGVybmFsSXAoKS50aGVuKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5uZXR3b3JrLmV4dGVybmFsSXAgPSBhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLmNhdGNoKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvYmplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShvYmplY3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xufTtcbiJdfQ==
