"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var os = require("os");
var child_process = require("child_process");
var Promise = require("bluebird");
var superagent = require("superagent");
var lsusbdev_1 = require("lsusbdev");
var linux_cpu_temp_1 = require("linux-cpu-temp");
var networkstatus_1 = require("networkstatus");
var lsdisks = require("ls-disks");
var exec = child_process.exec;
function getExternalIp() {
    return new Promise(function (resolve, reject) {
        superagent.get('https://api.ipify.org?format=json').end(function (err, res) {
            if (err) {
                reject(err);
            }
            else {
                resolve(res.body.ip);
            }
        });
    });
}
function sysinfo() {
    return new Promise(function (resolve, reject) {
        var object = {};
        object.updatedAt = new Date().getTime();
        var callbacked = false;
        var timo = setTimeout(function () {
            if (!callbacked) {
                console.log("timeout bootId read timeout");
                reject("timeout");
            }
        }, 10000);
        object.system = {
            loadavg: os.loadavg(),
            freemem: os.freemem(),
            totalmem: os.totalmem(),
            release: os.release(),
            arch: os.arch(),
            ostype: os.type(),
            platform: os.platform(),
            cores: os.cpus()
        };
        exec("cat /proc/sys/kernel/random/boot_id", { timeout: 9000 }, function (error, stdout, stderr) {
            if (error != null) {
                callbacked = true;
                clearTimeout(timo);
                reject(error);
            }
            else if (stderr && stderr != null) {
                callbacked = true;
                clearTimeout(timo);
                reject(stderr);
            }
            else {
                callbacked = true;
                clearTimeout(timo);
                var callbacked2_1 = false;
                var timo2_1 = setTimeout(function () {
                    if (!callbacked2_1) {
                        console.log("timeout bootTime read timeout");
                        reject("timeout");
                    }
                }, 10000);
                object.bootId = stdout.toString().replace("\n", "");
                exec("cat /proc/stat | grep btime | awk '{ print $2 }'", { timeout: 9000 }, function (error, stdout, stderr) {
                    if (error != null) {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        reject(error);
                    }
                    else if (stderr && stderr != null) {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        reject(stderr);
                    }
                    else {
                        callbacked2_1 = true;
                        clearTimeout(timo2_1);
                        object.bootTime = parseInt(stdout.toString()) * 1000;
                        lsusbdev_1.default().then(function (data) {
                            object.usbDevices = data;
                            object.drives = lsdisks.all();
                            networkstatus_1.default().then(function (data) {
                                object.networks = data.networks;
                                object.network = data.network;
                                if (object.network) {
                                    object.network.externalIp = '';
                                }
                                linux_cpu_temp_1.default().then(function (a) {
                                    object.cputemp = a;
                                    if (object.network) {
                                        getExternalIp().then(function (a) {
                                            object.network.externalIp = a;
                                            resolve(object);
                                        }).catch(function () {
                                            resolve(object);
                                        });
                                    }
                                    else {
                                        resolve(object);
                                    }
                                }).catch(function (err) {
                                    if (object.network) {
                                        getExternalIp().then(function (a) {
                                            object.network.externalIp = a;
                                            resolve(object);
                                        }).catch(function () {
                                            resolve(object);
                                        });
                                    }
                                    else {
                                        resolve(object);
                                    }
                                });
                            });
                        });
                    }
                });
            }
        });
    });
}
exports.sysinfo = sysinfo;
;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsdUJBQXlCO0FBQ3pCLDZDQUErQztBQUUvQyxrQ0FBb0M7QUFFcEMsdUNBQXlDO0FBR3pDLHFDQUE2QjtBQUU3QixpREFBc0M7QUFHdEMsK0NBQXlDO0FBR3pDLGtDQUFvQztBQUVwQyxJQUFNLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO0FBb0hoQztJQUNJLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBUyxVQUFVLE9BQU8sRUFBRSxNQUFNO1FBRWhELFVBQVUsQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxHQUFHLEVBQUUsR0FBRztZQUN0RSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNOLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUNmLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUN4QixDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFFRDtJQUNJLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBUyxVQUFVLE9BQU8sRUFBRSxNQUFNO1FBR2hELElBQUksTUFBTSxHQUFXLEVBQUUsQ0FBQztRQUN4QixNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFeEMsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksSUFBSSxHQUFHLFVBQVUsQ0FBQztZQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO2dCQUMzQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdEIsQ0FBQztRQUNMLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNWLE1BQU0sQ0FBQyxNQUFNLEdBQUc7WUFDWixPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFBRTtZQUNyQixPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFBRTtZQUNyQixRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUN2QixPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFBRTtZQUNyQixJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksRUFBRTtZQUNmLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxFQUFFO1lBQ2pCLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxFQUFFO1lBQ3ZCLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxFQUFFO1NBQ25CLENBQUM7UUFDRixJQUFJLENBQUMscUNBQXFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsVUFBVSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU07WUFDMUYsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBQ2xCLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xCLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNsQyxVQUFVLEdBQUcsSUFBSSxDQUFDO2dCQUNsQixZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNuQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osVUFBVSxHQUFHLElBQUksQ0FBQztnQkFDbEIsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVuQixJQUFJLGFBQVcsR0FBRyxLQUFLLENBQUM7Z0JBQ3hCLElBQUksT0FBSyxHQUFHLFVBQVUsQ0FBQztvQkFDbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFXLENBQUMsQ0FBQyxDQUFDO3dCQUNmLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0JBQStCLENBQUMsQ0FBQzt3QkFDN0MsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO29CQUN0QixDQUFDO2dCQUNMLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFFVixNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUVwRCxJQUFJLENBQUMsa0RBQWtELEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEVBQUUsVUFBVSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU07b0JBQ3ZHLEVBQUUsQ0FBQyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUNoQixhQUFXLEdBQUcsSUFBSSxDQUFDO3dCQUNuQixZQUFZLENBQUMsT0FBSyxDQUFDLENBQUM7d0JBQ3BCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDbEIsQ0FBQztvQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO3dCQUNsQyxhQUFXLEdBQUcsSUFBSSxDQUFDO3dCQUNuQixZQUFZLENBQUMsT0FBSyxDQUFDLENBQUM7d0JBQ3BCLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDbkIsQ0FBQztvQkFBQyxJQUFJLENBQUMsQ0FBQzt3QkFDSixhQUFXLEdBQUcsSUFBSSxDQUFDO3dCQUNuQixZQUFZLENBQUMsT0FBSyxDQUFDLENBQUM7d0JBRXBCLE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQzt3QkFFckQsa0JBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUk7NEJBQ3ZCLE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDOzRCQUN6QixNQUFNLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQzs0QkFDOUIsdUJBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLElBQWdCO2dDQUMzQyxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7Z0NBQ2hDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQ0FDOUIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7b0NBQ2pCLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQTtnQ0FDbEMsQ0FBQztnQ0FFRCx3QkFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQztvQ0FDZCxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQTtvQ0FDbEIsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7d0NBQ2pCLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUM7NENBQ25CLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQTs0Q0FDN0IsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO3dDQUNuQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7NENBQ0wsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFBO3dDQUNuQixDQUFDLENBQUMsQ0FBQTtvQ0FDTixDQUFDO29DQUFDLElBQUksQ0FBQyxDQUFDO3dDQUNKLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTtvQ0FDbkIsQ0FBQztnQ0FDTCxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHO29DQUNULEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO3dDQUNqQixhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDOzRDQUNuQixNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUE7NENBQzdCLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTt3Q0FDbkIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDOzRDQUNMLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQTt3Q0FDbkIsQ0FBQyxDQUFDLENBQUE7b0NBQ04sQ0FBQztvQ0FBQyxJQUFJLENBQUMsQ0FBQzt3Q0FDSixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7b0NBQ25CLENBQUM7Z0NBQ0wsQ0FBQyxDQUFDLENBQUE7NEJBRU4sQ0FBQyxDQUFDLENBQUM7d0JBQ1AsQ0FBQyxDQUFDLENBQUM7b0JBQ1AsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQXhHRCwwQkF3R0M7QUFBQSxDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgb3MgZnJvbSBcIm9zXCI7XG5pbXBvcnQgKiBhcyBjaGlsZF9wcm9jZXNzIGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5cbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5cbmltcG9ydCAqIGFzIHN1cGVyYWdlbnQgZnJvbSBcInN1cGVyYWdlbnRcIjtcblxuXG5pbXBvcnQgbHN1c2IgZnJvbSBcImxzdXNiZGV2XCI7XG5cbmltcG9ydCB0ZW1wY3B1cyBmcm9tIFwibGludXgtY3B1LXRlbXBcIjtcblxuXG5pbXBvcnQgbmV0d29ya3N0YXR1cyBmcm9tIFwibmV0d29ya3N0YXR1c1wiXG5cblxuaW1wb3J0ICogYXMgbHNkaXNrcyBmcm9tIFwibHMtZGlza3NcIjtcblxuY29uc3QgZXhlYyA9IGNoaWxkX3Byb2Nlc3MuZXhlYztcblxuaW50ZXJmYWNlIEljb3JlcyB7XG5cbiAgICB0ZW1wOiBudW1iZXI7XG4gICAgdW5pdDogc3RyaW5nXG4gICAgY29yZW51bWJlcjogbnVtYmVyO1xuICAgIHZlcnNpb246IHN0cmluZztcbn1cblxuXG5pbnRlcmZhY2UgSXRlbXAge1xuXG4gICAgdGVtcGVyYXR1cmU6IG51bWJlcjtcbiAgICB1bml0OiBzdHJpbmc7XG4gICAgbWF4OiBudW1iZXI7XG4gICAgbWluOiBudW1iZXI7XG4gICAgY29yZXM6IEljb3Jlc1tdO1xuXG59XG5cblxuXG5cbmludGVyZmFjZSBJU2NhbiB7XG4gICAgZXNzaWQ6IHN0cmluZztcbiAgICBtYWM6IHN0cmluZztcbiAgICBzaWduYWw6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElOZXR3b3JrIHtcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgbWFjOiBzdHJpbmc7XG4gICAgaW50ZXJmYWNlOiBzdHJpbmc7XG4gICAgZXNzaWQ/OiBzdHJpbmc7XG4gICAgc2Nhbj86IElTY2FuW107XG4gICAgaXA/OiBzdHJpbmc7XG4gICAgZ2F0ZXdheT86IHN0cmluZztcbiAgICBleHRlcm5hbElwPzogc3RyaW5nO1xufVxuXG5cbmludGVyZmFjZSBJTmV0U3RhdHVzIHtcblxuICAgIG5ldHdvcmtzOiBJTmV0d29ya1tdO1xuICAgIG5ldHdvcms6IElOZXR3b3JrO1xufVxuXG5cblxuaW50ZXJmYWNlIExzdXNiZGV2QW5zd2VyIHtcbiAgICBkZXY6IHN0cmluZztcbiAgICB0eXBlOiBzdHJpbmc7XG4gICAgaHViOiBzdHJpbmc7XG4gICAgcHJvZHVjdDogc3RyaW5nO1xuICAgIGlkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJUGFydGl0aW9uIHtcbiAgICBwYXJ0aXRpb246IHN0cmluZztcbiAgICBzZWN0b3JzOiBudW1iZXI7XG4gICAgc2VjdG9yc19zdGFydDogbnVtYmVyO1xuICAgIHNlY3RvcnNfc3RvcDogbnVtYmVyO1xuICAgIHR5cGU6IHN0cmluZztcbiAgICBib290OiBib29sZWFuO1xuICAgIHNpemU6IG51bWJlcjtcbiAgICBsYWJlbD86IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgaHVtYW5zaXplOiBzdHJpbmc7XG4gICAgdXNlZDogc3RyaW5nO1xuICAgIGF2YWlsYWJsZTogc3RyaW5nO1xuICAgIHBlcmNlbnR1c2VkOiBzdHJpbmc7XG4gICAgbW91bnRlZDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSURpc2sge1xuICAgIGRpc2s6IHN0cmluZztcbiAgICBzZWN0b3JzOiBudW1iZXI7XG4gICAgc2l6ZTogbnVtYmVyO1xuICAgIHBhcnRpdGlvbnM6IElQYXJ0aXRpb25bXTtcbiAgICBibG9jazogbnVtYmVyO1xuICAgIHVzZWRfYmxvY2tzOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBJQ3B1IHtcbiAgICBtb2RlbDogc3RyaW5nO1xuICAgIHNwZWVkOiBudW1iZXI7XG4gICAgdGltZXM6IHtcbiAgICAgICAgdXNlcjogbnVtYmVyO1xuICAgICAgICBuaWNlOiBudW1iZXI7XG4gICAgICAgIHN5czogbnVtYmVyO1xuICAgICAgICBpZGxlOiBudW1iZXI7XG4gICAgICAgIGlycTogbnVtYmVyXG4gICAgfVxufVxuaW50ZXJmYWNlIEFuc3dlciB7XG4gICAgYm9vdElkOiBzdHJpbmc7XG4gICAgYm9vdFRpbWU6IG51bWJlcjtcbiAgICB1cGRhdGVkQXQ6IG51bWJlcjtcbiAgICB1c2JEZXZpY2VzOiBMc3VzYmRldkFuc3dlcltdO1xuICAgIGRyaXZlczogSURpc2tbXTtcbiAgICBuZXR3b3JrczogSU5ldHdvcmtbXTtcbiAgICBuZXR3b3JrOiBJTmV0d29yaztcbiAgICBjcHV0ZW1wOiBJdGVtcDtcbiAgICBzeXN0ZW06IHtcbiAgICAgICAgbG9hZGF2ZzogbnVtYmVyW107XG4gICAgICAgIGZyZWVtZW06IG51bWJlcjtcbiAgICAgICAgdG90YWxtZW06IG51bWJlcjtcbiAgICAgICAgcmVsZWFzZTogc3RyaW5nO1xuICAgICAgICBhcmNoOiBzdHJpbmc7XG4gICAgICAgIG9zdHlwZTogc3RyaW5nO1xuICAgICAgICBwbGF0Zm9ybTogc3RyaW5nO1xuICAgICAgICBjb3JlczogSUNwdVtdO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2V0RXh0ZXJuYWxJcCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcblxuICAgICAgICBzdXBlcmFnZW50LmdldCgnaHR0cHM6Ly9hcGkuaXBpZnkub3JnP2Zvcm1hdD1qc29uJykuZW5kKGZ1bmN0aW9uIChlcnIsIHJlcykge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzLmJvZHkuaXApXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN5c2luZm8oKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPEFuc3dlcj4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuXG5cbiAgICAgICAgbGV0IG9iamVjdCA9IDxBbnN3ZXI+e307XG4gICAgICAgIG9iamVjdC51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcblxuICAgICAgICBsZXQgY2FsbGJhY2tlZCA9IGZhbHNlO1xuICAgICAgICBsZXQgdGltbyA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCFjYWxsYmFja2VkKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0aW1lb3V0IGJvb3RJZCByZWFkIHRpbWVvdXRcIik7XG4gICAgICAgICAgICAgICAgcmVqZWN0KFwidGltZW91dFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgMTAwMDApO1xuICAgICAgICBvYmplY3Quc3lzdGVtID0ge1xuICAgICAgICAgICAgbG9hZGF2Zzogb3MubG9hZGF2ZygpLFxuICAgICAgICAgICAgZnJlZW1lbTogb3MuZnJlZW1lbSgpLFxuICAgICAgICAgICAgdG90YWxtZW06IG9zLnRvdGFsbWVtKCksXG4gICAgICAgICAgICByZWxlYXNlOiBvcy5yZWxlYXNlKCksXG4gICAgICAgICAgICBhcmNoOiBvcy5hcmNoKCksXG4gICAgICAgICAgICBvc3R5cGU6IG9zLnR5cGUoKSxcbiAgICAgICAgICAgIHBsYXRmb3JtOiBvcy5wbGF0Zm9ybSgpLFxuICAgICAgICAgICAgY29yZXM6IG9zLmNwdXMoKVxuICAgICAgICB9O1xuICAgICAgICBleGVjKFwiY2F0IC9wcm9jL3N5cy9rZXJuZWwvcmFuZG9tL2Jvb3RfaWRcIiwgeyB0aW1lb3V0OiA5MDAwIH0sIGZ1bmN0aW9uIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbW8pO1xuICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0ZGVyciAmJiBzdGRlcnIgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1vKTtcbiAgICAgICAgICAgICAgICByZWplY3Qoc3RkZXJyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbW8pO1xuXG4gICAgICAgICAgICAgICAgbGV0IGNhbGxiYWNrZWQyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgbGV0IHRpbW8yID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghY2FsbGJhY2tlZDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidGltZW91dCBib290VGltZSByZWFkIHRpbWVvdXRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoXCJ0aW1lb3V0XCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSwgMTAwMDApO1xuXG4gICAgICAgICAgICAgICAgb2JqZWN0LmJvb3RJZCA9IHN0ZG91dC50b1N0cmluZygpLnJlcGxhY2UoXCJcXG5cIiwgXCJcIik7XG5cbiAgICAgICAgICAgICAgICBleGVjKFwiY2F0IC9wcm9jL3N0YXQgfCBncmVwIGJ0aW1lIHwgYXdrICd7IHByaW50ICQyIH0nXCIsIHsgdGltZW91dDogOTAwMCB9LCBmdW5jdGlvbiAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja2VkMiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltbzIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGRlcnIgJiYgc3RkZXJyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrZWQyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1vMik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3Qoc3RkZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrZWQyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1vMik7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC5ib290VGltZSA9IHBhcnNlSW50KHN0ZG91dC50b1N0cmluZygpKSAqIDEwMDA7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGxzdXNiKCkudGhlbihmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdC51c2JEZXZpY2VzID0gZGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QuZHJpdmVzID0gbHNkaXNrcy5hbGwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXR3b3Jrc3RhdHVzKCkudGhlbihmdW5jdGlvbiAoZGF0YTogSU5ldFN0YXR1cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QubmV0d29ya3MgPSBkYXRhLm5ldHdvcmtzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QubmV0d29yayA9IGRhdGEubmV0d29yaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9iamVjdC5uZXR3b3JrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QubmV0d29yay5leHRlcm5hbElwID0gJydcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBjcHVzKCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0LmNwdXRlbXAgPSBhXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0Lm5ldHdvcmspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRFeHRlcm5hbElwKCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QubmV0d29yay5leHRlcm5hbElwID0gYVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG9iamVjdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0Lm5ldHdvcmspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnZXRFeHRlcm5hbElwKCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QubmV0d29yay5leHRlcm5hbElwID0gYVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG9iamVjdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5jYXRjaCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUob2JqZWN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbn07XG4iXX0=
